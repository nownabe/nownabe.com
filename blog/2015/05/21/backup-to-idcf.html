<!DOCTYPE html><html><head><meta charset="utf-8" /><title>nownab.log - 超簡単にサーバのデータをIDCFオブストに定期バックアップするItamaeプラグイン</title><meta content="IE=edge;chrome=1" http-equiv="X-UA-Compatible" /><meta content="width=device-width, initial-scale=1.0" name="viewport" /><link href="https://storage.googleapis.com/code.getmdl.io/1.0.4/material.light_blue-pink.min.css" rel="stylesheet" /><script src="https://storage.googleapis.com/code.getmdl.io/1.0.0/material.min.js"></script><link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" /><link href="../../../../stylesheets/blog.css" rel="stylesheet" /><link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/blog/feed.xml" /></head><body><div class="mdl-layout mdl-js-layout" id="container"><header><h1 id="title"><a href="/blog">nownab.log</a><small><i class="material-icons md-18">description</i><span id="subtitle">logger.level = Logger::DEBUG</span></small></h1></header><div id="main" role="main"><h1 id="section">はじめに</h1>
<p>サーバのあるディレクトリ内のファイルを<a href="http://www.idcf.jp/cloud/storage/">IDCFのオブジェクトストレージ</a>に定期バックアップする<a href="http://itamae.kitchen/">Itamae</a>プラグインを作ったので紹介します！</p>

<p>[https://github.com/nownabe-infra/itamae-plugin-recipe-idcf-backup_to_object_storage:embed:cite]</p>

<h1 id="section-1">結論</h1>
<p>作ったのは<code>itamae-plugin-recipe-idcf-backup_to_object_storage</code>というクソ長い名前のGem（Itamaeプラグイン）です。
このプラグインを使うと、下の図のように任意の期間のバックアップファイルをオブジェクトストレージに保存することができます。</p>

<p>[f:id:nownabe:20150521000006p:plain]</p>

<h1 id="section-2">概要</h1>
<p>このプラグインを使ってプロビジョニングするとどうなるのか簡単に説明します。</p>

<ul>
  <li>バックアップスクリプトが作成される</li>
  <li>バックアップスクリプトを叩くcronジョブが作成される</li>
  <li>バックアップスクリプトは
    <ul>
      <li>指定されたサーバのディレクトリと指定されたオブストのバケットを同期する</li>
      <li>指定された期間より古いファイルはサーバからもオブストからも削除する</li>
    </ul>
  </li>
  <li>バックアップ実行前に任意のコマンドを実行できる
    <ul>
      <li>mysqldumpとかtar zcfとか</li>
      <li>このコマンドで、指定したディレクトリ内にバックアップファイルを生成する</li>
    </ul>
  </li>
</ul>

<h1 id="section-3">使い方</h1>
<p>## サンプル
サンプルを見てもらうのが一番はやいと思います。</p>

<p>[https://github.com/nownabe-infra/example-idcf-backup_to_object_storage:title]</p>

<h2 id="gemfile">Gemfile</h2>
<p>Gemfileにプラグインを追加します。</p>

<p><code>ruby
# Gemfile
source "https://rubygems.org"
gem "itamae-plugin-recipe-idcf-backup_to_object_storage"
</code></p>

<p>bundle installも忘れずにやっておきましょう。</p>

<p><code>bash
$ bundle install
</code></p>

<h2 id="nodeyml">node.yml</h2>
<p>node.ymlでいろいろ設定します。</p>

<p><code>yaml
# node.yml
idcf:
  backup_to_object_storage:
    access_key: YOUR_ACCESS_KEY
    secret_key: YOUR_SECRET_KEY
    directories:
      - schedule: 30 3 * * *
        path: /backups
        bucket: backup.yourbucket
        expire: 7
        command: mysqldump -u root -x --all-databases &gt; /backups/dump_`date +\%Y\%m\%d\%H\%M`.sql
</code></p>

<ul>
  <li><code>idcf.backup_to_object_storage.access_key</code>: オブストのアクセスキー</li>
  <li><code>idcf.backup_to_object_storage.secret_key</code>: オブストのシークレットキー</li>
  <li><code>idcf.backup_to_object_storage.directories</code>: バックアップの設定の配列</li>
</ul>

<p>バックアップの設定は、次のようになってます。</p>

<ul>
  <li><code>schedule</code>: バックアップを実行するスケジュール。みんなおなじみのcron形式</li>
  <li><code>path</code>: バックアップ元のディレクトリ。この中のファイルをオブストに同期します</li>
  <li><code>bucket</code>: 同期先のバケット</li>
  <li><code>expire</code>: ファイルを保持する期間。ここで設定した日数より前に作成されたファイルは、サーバーからもオブストからも削除されます</li>
  <li><code>command</code>: (optional) バックアップ前に実行するコマンド。だいたいはこのコマンドで<code>path</code>のディレクトリ内にバックアップファイルを作ることになると思います</li>
</ul>

<p>上記のサンプルだと、</p>

<ul>
  <li>毎日3時30分に</li>
  <li>mysqldumpで/backupsディレクトリに全データベースのdumpをとる</li>
  <li>7日前より古く作成されたファイルを削除する</li>
  <li>/backupsディレクトリをbackup.yourbucketに同期する</li>
</ul>

<p>という一連の処理になります。</p>

<h2 id="recipe">recipe</h2>
<p>recipeには、1行追加するだけでOKです。</p>

<p><code>ruby
# recipe.rb
include_recipe "idcf-backup_to_object_storage"
</code></p>

<h2 id="section-4">プロビジョニング</h2>
<p>最後に、SSH経由でプロビジョニングします。</p>

<p><code>bash
$ bundle exec itamae ssh -h ${YOURHOST} -y node.yml recipe.rb
</code></p>

<p>ユーザを指定する場合は<code>-u</code>オプション、ポートを指定する場合は<code>-p</code>オプションを使います。</p>

<p>プロビジョニングが完了してスケジュールが実行されると、オブストにバックアップファイルがアップロードされているはずです。
コントロールパネルでファイル一覧を表示できるので確認してみてください。</p>

<h1 id="section-5">おわりに</h1>
<p>プルリクお待ちしております！</p>
</div><aside><h2>Recent Articles</h2><ol><li><a href="/blog/2015/09/22/test.html">Example Article</a><span>Sep 22</span></li><li><a href="/blog/2015/08/31/redundant-geminabox.html">Gem in a Boxの冗長化</a><span>Aug 31</span></li><li><a href="/blog/2015/08/10/idcf-dns.html">お名前.comからIDCF DNSに移行した話</a><span>Aug 10</span></li><li><a href="/blog/2015/08/09/raspberry-pi-lchika.html">今更Raspberry PiでLチカやってみた</a><span>Aug  9</span></li><li><a href="/blog/2015/05/24/intro-headphone-amp.html">機材紹介：ヘッドホンアンプ</a><span>May 24</span></li><li><a href="/blog/2015/05/21/backup-to-idcf.html">超簡単にサーバのデータをIDCFオブストに定期バックアップするItamaeプラグイン</a><span>May 21</span></li><li><a href="/blog/2015/05/20/release-to-geminabox.html">Gem in a Boxに簡単にリリースできるGem作ったけどいっぱいあったのでまとめ</a><span>May 20</span></li><li><a href="/blog/2015/05/17/intro-wind-chime.html">機材紹介：ウィンドチャイム</a><span>May 17</span></li><li><a href="/blog/2015/04/19/github-pages.html">Github Pagesが便利すぎてイイ</a><span>Apr 19</span></li><li><a href="/blog/2015/03/14/serverfesta.html">サバフェス始まりました</a><span>Mar 14</span></li></ol><h2>Tags</h2><ol><li><a href="/blog/tags/band.html">band (2)</a></li><li><a href="/blog/tags/instruments.html">instruments (3)</a></li><li><a href="/blog/tags/drums.html">drums (2)</a></li><li><a href="/blog/tags/tech.html">tech (8)</a></li><li><a href="/blog/tags/ruby.html">ruby (4)</a></li><li><a href="/blog/tags/geminabox.html">geminabox (2)</a></li><li><a href="/blog/tags/itamae.html">itamae (1)</a></li><li><a href="/blog/tags/idcf.html">idcf (2)</a></li><li><a href="/blog/tags/diary.html">diary (4)</a></li><li><a href="/blog/tags/leveldb.html">leveldb (1)</a></li><li><a href="/blog/tags/ruboty.html">ruboty (1)</a></li><li><a href="/blog/tags/dns.html">dns (1)</a></li><li><a href="/blog/tags/raspberrypi.html">raspberrypi (1)</a></li><li><a href="/blog/tags/example.html">example (1)</a></li></ol><h2>By Year</h2><ol><li><a href="/blog/2015.html">2015 (15)</a></li></ol></aside></div></body></html>